<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="_csrf" th:content="${_csrf.token}" />
	<meta name="_csrf_header" th:content="${_csrf.headerName}" />
	<title>AdminLTE 3 | DataTables</title>
	
	<!-- Google Font: Source Sans Pro -->
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
	<!-- Font Awesome -->
	<link rel="stylesheet" href="../../plugins/fontawesome-free/css/all.min.css">
	<!-- Theme style -->
	<link rel="stylesheet" href="../../dist/css/adminlte.min.css">
	<!-- Toast UI Grid -->
	<link rel="stylesheet" href="https://uicdn.toast.com/grid/latest/tui-grid.css"/>
	<!-- daterange picker -->
	<link rel="stylesheet" href="../../plugins/daterangepicker/daterangepicker.css">
	
	<!-- jQuery -->
	<script src="../../plugins/jquery/jquery.min.js"></script>
	<!-- Bootstrap 4 -->
	<script src="../../plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
	<!-- AdminLTE App -->
	<script src="../../dist/js/adminlte.min.js"></script>
	<!-- InputMask -->
	<script src="../../plugins/moment/moment.min.js"></script>
	<script src="../../plugins/inputmask/jquery.inputmask.min.js"></script>
	<!-- date-range-picker -->
	<script src="../../plugins/daterangepicker/daterangepicker.js"></script>
	<!-- ChartJS -->
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<!-- Toast UI Grid -->
	<script src="https://uicdn.toast.com/tui-grid/latest/tui-grid.min.js"></script>
	<!-- SheetJS (Excel ë³€í™˜ ë¼ì´ë¸ŒëŸ¬ë¦¬) -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

	<style>
	    .selected-row {
	        background-color: #d1ffd6;
	    }
	    .deselected-row {
	        background-color: #ffd1d1;
	    }
	</style>
</head>
<body class="hold-transition sidebar-mini">
	<div class="wrapper">
		<!-- ìƒë‹¨ ë©”ë‰´ -->
		<nav th:replace="~{includes/navbar :: navbar}"></nav>
		<!-- /.ìƒë‹¨ ë©”ë‰´ -->

		<!-- ì¢Œì¸¡ ë©”ë‰´ -->
		<aside th:replace="~{includes/sidebar :: sidebar}"></aside>
		<!-- /.ì¢Œì¸¡ ë©”ë‰´ -->

		<!-- Content Wrapper. Contains page content -->
		<div class="content-wrapper">
			<!-- ì½˜í…ì¸  í—¤ë” (Page header) -->
			<!-- <nav th:replace="~{includes/pageHeader :: pageHeader}"></nav> -->
			
	        <div class="content-header">
	            <div class="container-fluid">
	                <div class="row mb-2">
	                    <div class="col-sm-6">
	                        <h1 class="m-0">ë°œì£¼(ì…ê³ ) í˜„í™© (ì˜ˆì‹œ)</h1>
	                    </div>
	                </div>
	            </div>
	        </div>
	        
	        <!-- ë©”ì¸ ì½˜í…ì¸  -->
	        <section class="content">
	            <div class="container-fluid">
	                <div class="row">
	                    <!-- ìƒì‚° í˜„í™© ì°¨íŠ¸ -->
	                    <div class="col-lg-6">
	                        <div class="card">
	                            <div class="card-header">
	                                <h3 class="card-title">ì¼ë³„ ë°œì£¼ ìƒíƒœ</h3>
	                            </div>
	                            <div class="card-body">
	                                <canvas id="poChartDaily"></canvas>
	                            </div>
	                        </div>
	                    </div>
	
	                    <!-- ë¶ˆëŸ‰ë¥  ì°¨íŠ¸ -->
	                    <div class="col-lg-6">
	                        <div class="card">
	                            <div class="card-header">
	                                <h3 class="card-title">ì¼ë³„ ë¶ˆëŸ‰ë¥ </h3>
	                            </div>
	                            <div class="card-body">
	                                <canvas id="poInboundChart1"></canvas>
	                            </div>
	                        </div>
	                    </div>
	                </div>
					
					<div class="row">
					    <!-- ìƒì‚° í˜„í™© ì°¨íŠ¸ -->
					    <div class="col-lg-6">
					        <div class="card">
					            <div class="card-header">
					                <h3 class="card-title">ì£¼ë³„ ë°œì£¼ ìƒíƒœ</h3>
					            </div>
					            <div class="card-body">
					                <canvas id="poChartWeekly"></canvas>
					            </div>
					        </div>
					    </div>

					    <!-- ë¶ˆëŸ‰ë¥  ì°¨íŠ¸ -->
					    <div class="col-lg-6">
					        <div class="card">
					            <div class="card-header">
					                <h3 class="card-title">ì£¼ë³„ ë¶ˆëŸ‰ë¥ </h3>
					            </div>
					            <div class="card-body">
					                <canvas id="poInboundChart2"></canvas>
					            </div>
					        </div>
					    </div>
					</div>
					
					<div class="row">
					    <!-- ìƒì‚° í˜„í™© ì°¨íŠ¸ -->
					    <div class="col-lg-6">
					        <div class="card">
					            <div class="card-header">
					                <h3 class="card-title">ì›”ë³„ ë°œì£¼ ìƒíƒœ</h3>
					            </div>
					            <div class="card-body">
					                <canvas id="poChartMonthly"></canvas>
					            </div>
					        </div>
					    </div>

					    <!-- ë¶ˆëŸ‰ë¥  ì°¨íŠ¸ -->
					    <div class="col-lg-6">
					        <div class="card">
					            <div class="card-header">
					                <h3 class="card-title">ì›”ë³„ ë¶ˆëŸ‰ë¥ </h3>
					            </div>
					            <div class="card-body">
					                <canvas id="poInboundChart3"></canvas>
					            </div>
					        </div>
					    </div>
					</div>
					
	                <!-- ë°œì£¼ í˜„í™© (ì‹¤ì ) ê·¸ë¦¬ë“œ -->
	                <div class="row">
	                    <div class="col-12">
	                        <div class="card">
	                            <div class="card-header">
	                                <h3 class="card-title">ë°œì£¼ í˜„í™©</h3>
	                            </div>
	                            <div class="card-body">
	                                <div id="clientPoGrid"></div>
	                            </div>
	                        </div>
	                    </div>
	                </div>
					
					<!-- ê±°ë˜ì²˜ë³„ ë¶ˆëŸ‰ë¥  ì°¨íŠ¸ -->
					<div class="row">
					    <div class="col-12">
					        <div class="card">
					            <div class="card-header">
					                <h3 class="card-title">ê±°ë˜ì²˜ë³„ ë¶ˆëŸ‰ë¥ </h3>
					            </div>
								<div class="card-body">
								    <canvas id="clientInboundChart" style="height: 300px;"></canvas>
								</div>
					        </div>
					    </div>
					</div>
	            </div>
	        </section>
	        <!-- /.content -->
		</div>
		<!-- /.content-wrapper -->
		
		<!-- í•˜ë‹¨ ë©”ë‰´ -->
		<footer th:replace="~{includes/footer :: footer}"></footer>
		<!-- /.í•˜ë‹¨ ë©”ë‰´ -->
		
		<!-- Control Sidebar -->
		<aside class="control-sidebar control-sidebar-dark">
			<!-- Control sidebar content goes here -->
		</aside>
		<!-- /.control-sidebar -->
	</div>
	<!-- ./wrapper -->

	<!-- Page specific script -->
	<script th:inline="javascript">
	
		// ê±°ë˜ì²˜ë³„ ë°œì£¼ëŸ‰ ê·¸ë¦¬ë“œ
		let clientPoGrid = null;
		const clientPoUrl = '/rest/dashboard/clientPo';
		const clientPoDataSource = {
			api: {
			    readData: {url: clientPoUrl, method: 'GET'},
			},
			contentType: 'application/json',
	    };
		let clientPoCurrentSelectedRowKey = null;
		let clientPoCurrentSelectedID = null;
		let clientPoIsEditModeEnabled = false; 
		const clientPo_columns = [
	        {header: 'ê±°ë˜ì²˜ëª…', name: 'CLIENT_NAME', align: 'center', sortable: true, editor: null},
	        {header: 'ìì¬ ì½”ë“œ', name: 'MATERIAL_ID', align: 'center', sortable: true, editor: null},
	        {header: 'ìì¬ëª…', name: 'MATERIAL_NAME', align: 'center', editor: null},
	        {header: 'ë°œì£¼ëŸ‰', name: 'TOTAL_PO_COUNT', align: 'center', sortable: true, editor: null},
	        {header: 'ë¶ˆëŸ‰ê°œìˆ˜', name: 'TOTAL_DEFECT_QUANTITY', align: 'center', sortable: true, editor: null},
	    ];
		
	    // Chart.jsë¥¼ ì‚¬ìš©í•˜ì—¬ ì°¨íŠ¸ ìƒì„±
		$(function () {
		    clientPoInit();
		    
		    stackedBarChart('poChartDaily', false);
		    //stackedBarChart('poChartWeekly', false);
		    //stackedBarChart('poChartMonthly', false);
		    
		    lineChart('poInboundChart1', false);

			clientInboundChart('clientInboundChart', false);
		});
	    
		// clientPoGrid ì„¸íŒ…
		function clientPoInit() {
			clientPoGrid = new tui.Grid({
		        el: document.getElementById('clientPoGrid'),
		        data: clientPoDataSource,
		        scrollX: true,
		        scrollY: true,
		        bodyHeight: 250,
				editingEvent: 'click',
		        columns: clientPo_columns,
		    });

			clientPoGrid.on('failResponse', function(ev) {
		        alert(JSON.parse(ev.xhr.responseText).message);
		    });
		}
	    
		
		function stackedBarChart(chartId, isUpdate) {
		    $.ajax({
		        type: "POST",
		        url: "/dashboard/getPoStackedChart",
		        success: function (res) {
		        	
		        	console.log(res);
		        	
		            let labels = [];
		            let poStatusMap = {}; // { 'ë¯¸ê²°': [], 'ì§„í–‰ì¤‘': [], 'ë§ˆê°': [], 'ê²€ìˆ˜ë§ˆê°': [] }
		            let statusColors = {
		                'ë¯¸ê²°': '#f56954',
		                'ì§„í–‰ì¤‘': '#f39c12',
		                'ë§ˆê°': '#00a65a',
		                'ê²€ìˆ˜ë§ˆê°': '#00c0ef',
		                'ë¯¸ì •': '#3c8dbc'
		            };
		
		            // ë°ì´í„° ì „ì²˜ë¦¬ : ë‚ ì§œë³„ ê·¸ë£¹í™”
		            res.forEach((el) => {
		                let date = el.ORDER_DATE;
		                let status = el.PO_TEXT;
		                let value = el.STACK_CHART_VALUE;
		
		                if (!labels.includes(date)) {
		                    labels.push(date);
		                }
		
		                if (!poStatusMap[status]) {
		                    poStatusMap[status] = [];
		                }
		            });
		
		            // ëª¨ë“  ë‚ ì§œì— ëŒ€í•´ ì´ˆê¸°í™”
		            labels.forEach((date) => {
		                for (let status in poStatusMap) {
		                    poStatusMap[status].push(0); // ê¸°ë³¸ê°’ 0ìœ¼ë¡œ ì´ˆê¸°í™”
		                }
		            });
		
		            // ì‹¤ì œ ë°ì´í„° ë°˜ì˜
		            res.forEach((el) => {
		                let dateIndex = labels.indexOf(el.ORDER_DATE);
		                let status = el.PO_TEXT;
		                poStatusMap[status][dateIndex] = el.STACK_CHART_VALUE;
		            });
		
		            // Chart.jsì˜ datasets í˜•ì‹ìœ¼ë¡œ ë³€í™˜
		            let datasets = [];
		            for (let status in poStatusMap) {
		                datasets.push({
		                    label: status,
		                    backgroundColor: statusColors[status],
		                    data: poStatusMap[status]
		                });
		            }
		
		            let stackedBarChartCanvas = $('#' + chartId).get(0).getContext('2d');
		            let stackedBarChartData = {
		                labels: labels,
		                datasets: datasets
		            };
		
		            let stackedBarChartOptions = {
		                maintainAspectRatio: false,
		                responsive: true,
		                scales: {
		                    x: { stacked: true },
		                    y: { stacked: true }
		                }
		            };
		
		            // ê¸°ì¡´ ì°¨íŠ¸ ì‚­ì œ í›„ ì¬ìƒì„±
		            if (isUpdate && window.myStackedBarChart) {
		                window.myStackedBarChart.destroy();
		            }
		
		            window.myStackedBarChart = new Chart(stackedBarChartCanvas, {
		                type: 'bar',
		                data: stackedBarChartData,
		                options: stackedBarChartOptions
		            });
		        },
		        error: function (XMLHttpRequest, textStatus, errorThrown) {
		            console.log("stackedBarChart() ajax ì‹¤íŒ¨");
		        }
		    });
		}
		
		function clientInboundChart(chartId, isUpdate) {
		    $.ajax({
		        type: "POST",
		        url: "/dashboard/getClientInbound",
		        success: function (res) {
		            let labels = [];   // Xì¶• (ê±°ë˜ì²˜ëª…)
		            let data = [];     // Yì¶• (ë¶ˆëŸ‰ë¥  %)
		            
		            console.log(res);
		            
		            res.forEach((el) => {
		                labels.push(el.CLIENT_NAME);
		                data.push(el.DEFECT_RATE);
		            });

		            let ctx = $('#' + chartId).get(0).getContext('2d');
		            
		            // ê¸°ì¡´ ì°¨íŠ¸ ì‚­ì œ í›„ ì¬ìƒì„±
		            if (isUpdate && window.myClientInboundChart) {
		                window.myClientInboundChart.destroy();
		            }

		            window.myClientInboundChart = new Chart(ctx, {
		                type: 'bar',
		                data: {
		                    labels: labels,
		                    datasets: [{
		                        label: 'ë¶ˆëŸ‰ë¥  (%)',
		                        data: data,
		                        backgroundColor: 'rgba(255, 99, 132, 0.7)',
		                        borderColor: 'rgba(255, 99, 132, 1)',
		                        borderWidth: 1
		                    }]
		                },
		                options: {
		                    responsive: true,
		                    maintainAspectRatio: false,
		                    scales: {
		                        x: {
		                            /* title: {
		                                display: true,
		                                text: 'ê±°ë˜ì²˜'
		                            } */
		                        },
		                        y: {
		                            beginAtZero: true,
		                            max: 100,
		                            /* title: {
		                                display: true,
		                                text: 'ë¶ˆëŸ‰ë¥  (%)'
		                            } */
		                        }
		                    }
		                }
		            });
		        },
		        error: function () {
		            console.log("clientInboundChart() ajax ì‹¤íŒ¨");
		        }
		    });
		}
		
		function lineChart(chartId, isUpdate) {
		    $.ajax({
		        type: "GET",
		        url: "/rest/dashboard/inboundChart",
		        success: function (res) {
		            if (!res.result || !res.data) {
		                console.log("ğŸ“Œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
		                return;
		            }
		            
		            let labels = [];
		            let data = [];
		            
		            console.log(res);
		            
		            // ì„œë²„ì—ì„œ ë°›ì€ ê°ì²´ë¥¼ ë°°ì—´ë¡œ ë³€í™˜ í›„ ë°˜ë³µë¬¸ ì‹¤í–‰
		            res.data.contents.forEach((item) => {
		                labels.push(item.ORDER_DATE);  // Xì¶•: ë‚ ì§œ
		                data.push(item.DEFECT_RATE);   // Yì¶•: ë¶ˆëŸ‰ë¥  (%)
		            });

		            // ì°¨íŠ¸ ì»¨í…ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
		            const ctx = $('#' + chartId).get(0).getContext('2d');

		            // ê¸°ì¡´ ì°¨íŠ¸ê°€ ìˆìœ¼ë©´ ì‚­ì œ í›„ ë‹¤ì‹œ ê·¸ë¦¼
		            if (isUpdate && window.myLineChart) {
		                window.myLineChart.destroy();
		            }

		            // ë¶ˆëŸ‰ë¥  ë¼ì¸ ì°¨íŠ¸ ìƒì„±
		            window.myLineChart = new Chart(ctx, {
		                type: 'line',
		                data: {
		                    labels: labels, // Xì¶• (ì¼ì)
		                    datasets: [{
		                        label: 'ë¶ˆëŸ‰ë¥  (%)',
		                        data: data, // Yì¶• (ë¶ˆëŸ‰ë¥  %)
		                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
		                        borderColor: 'rgba(255, 99, 132, 1)',
		                        borderWidth: 2,
		                        pointRadius: 5,
		                        pointBackgroundColor: 'rgba(255, 99, 132, 1)',
		                        fill: false,
		                        tension: 0.1 // ë¶€ë“œëŸ¬ìš´ ê³¡ì„  íš¨ê³¼
		                    }]
		                },
		                options: {
		                    responsive: true,
		                    maintainAspectRatio: false,
		                    scales: {
		                        x: {
		                            /* title: {
		                                display: true,
		                                text: 'ë‚ ì§œ'
		                            } */
		                        },
		                        y: {
		                            beginAtZero: true,	// ìµœì†Œê°’ 0ìœ¼ë¡œ ì„¤ì •
 		                            /* title: {
		                                display: true,
		                                text: 'ë¶ˆëŸ‰ë¥  (%)'
		                            }, */
		                            ticks: {
		                                callback: function (value) {
		                                    return value + "%"; // Yì¶• % ë‹¨ìœ„ í‘œì‹œ
		                                }
		                            }
		                        }
		                    },
		                    plugins: {
		                        tooltip: {
		                            callbacks: {
		                                label: function (tooltipItem) {
		                                    return tooltipItem.raw + " %"; // íˆ´íŒì— % í‘œì‹œ
		                                }
		                            }
		                        }
		                    }
		                }
		            });
		        },
		        error: function () {
		            console.log("lineChart() ajax ì‹¤íŒ¨");
		        }
		    });
		}
	</script>
</body>
</html>
