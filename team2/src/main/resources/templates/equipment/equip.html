<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="_csrf" th:content="${_csrf.token}" />
	<meta name="_csrf_header" th:content="${_csrf.headerName}" />
	<title>AdminLTE 3 | DataTables</title>

	<!-- Google Font: Source Sans Pro -->
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
	<!-- Font Awesome -->
	<link rel="stylesheet" href="../../plugins/fontawesome-free/css/all.min.css">
	<!-- Theme style -->
	<link rel="stylesheet" href="../../dist/css/adminlte.min.css">
	<!-- Toast UI Grid -->
	<link rel="stylesheet" href="https://uicdn.toast.com/grid/latest/tui-grid.css"/>

	<link rel="stylesheet" href="https://uicdn.toast.com/select-box/latest/toastui-select-box.css" />
	
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/css/bootstrap-select.min.css">
	
	<link rel="stylesheet" href="https://uicdn.toast.com/tui.date-picker/latest/tui-date-picker.css" />
	
	<link rel="stylesheet" href="https://uicdn.toast.com/calendar/latest/tui-calendar.css">
	
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.1/dist/css/bootstrap-select.min.css">
	
	<!-- jQuery -->
	<script src="../../plugins/jquery/jquery.min.js"></script>
	<!-- Bootstrap 4 -->
	<script src="../../plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
	<!-- AdminLTE App -->
	<script src="../../dist/js/adminlte.min.js"></script>
	<!-- Toast UI Grid -->
	<script src="https://uicdn.toast.com/tui-grid/latest/tui-grid.min.js"></script>
	<!-- SheetJS (Excel ë³€í™˜ ë¼ì´ë¸ŒëŸ¬ë¦¬) -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

	<style>
	    .selected-row {
	        background-color: #d1ffd6;
	    }
	    .deselected-row {
	        background-color: #ffd1d1;
	    }
	    
		.equip-container {
	        display: flex;
	        align-items: center;
	        gap: 15px; /* labelê³¼ input ê°„ê²© ìœ ì§€ */
	    }
	
	    .equip-label {
	        flex: 0 0 auto;
	        white-space: nowrap;
	        text-align: right;
	    }
	
	    .equip-input {
	        width: 150px;
	    }
	
	    .equip-select {
	        min-width: 120px;
	    }
	</style>
</head>
<body class="hold-transition sidebar-mini">
	<div class="wrapper">

		<!-- ìƒë‹¨ ë©”ë‰´ -->
		<nav th:replace="~{includes/navbar :: navbar}"></nav>
		<!-- /.ìƒë‹¨ ë©”ë‰´ -->

		<!-- ì¢Œì¸¡ ë©”ë‰´ -->
		<aside th:replace="~{includes/sidebar :: sidebar}"></aside>
		<!-- /.ì¢Œì¸¡ ë©”ë‰´ -->
				
		<!-- ì„¤ë¹„ì½”ë“œ ì¤‘ë³µì²˜ë¦¬ ê²€ì¦ ëª¨ë‹¬ -->
		<nav th:replace="~{includes/modals/mesCodeValidate :: mesCodeValidate}"></nav>

		<!-- ì—‘ì…€ ê¸°ëŠ¥ ëª¨ë‹¬ -->
		<nav th:replace="~{includes/modals/excelModal :: excelModal}"></nav>
		
		<!-- Content Wrapper. Contains page content -->
		<div class="content-wrapper">
			<!-- ì½˜í…ì¸  í—¤ë” (Page header) -->
			<nav th:replace="~{includes/pageHeader :: pageHeader}"></nav>

			<!-- ë©”ì¸ ì½˜í…ì¸  -->
			<section class="content">
				<div class="container-fluid">
					<div class="row">
						<div class="col-12">
							<div class="card">
								<div class="card-header">
									<div class="d-flex justify-content-between">
								        <div class="equip-container">
								            <label class="col-form-label equip-label">ì„¤ë¹„ì½”ë“œ</label>
								            <input type="text" class="form-control equip-input" id="equipId">
								
								            <label class="col-form-label equip-label">ì„¤ë¹„ëª…</label>
								            <input type="text" class="form-control equip-input" id="equipName">
								
								            <label class="col-form-label equip-label">ì‚¬ìš©ì—¬ë¶€</label>
								            <select class="equip3 form-control equip-select" name="equipStatus">
												<option value="" selected="selected">ì „ì²´</option>
												<option value="Y">ì‚¬ìš©</option>
												<option value="N">ë¯¸ì‚¬ìš©</option>
								            </select>
								        </div>

								        <input type="button" id="btn_equip_search" class="btn btn-primary" value="ì¡°íšŒ">
								    </div> 
								</div>
								<div class="card-body">
									<div class="row mb-3">
										<div class="col-3 d-flex align-items-center">
											<p class="font-weight-bold mb-0">ì„¤ë¹„ ëª©ë¡</p>
										</div>
										<div class="col-9">
											<div class="card-tools" style="text-align: right;">
												<input type="button" id="btn_equip_add_row" class="btn btn-primary" value="í–‰ì¶”ê°€" style="display : none;">
												<input type="button" id="btn_equip_remove_row" class="btn btn-danger" value="í–‰ì‚­ì œ" style="display : none;" >
												<input type="button" id="btn_equip_toggleEditMode" class="btn btn-warning" value="ì¶”ê°€ & í¸ì§‘">
												<input type="button" id="btn_equip_modify" class="btn btn-primary" value="ì €ì¥">
												<input type="button" id="btn_equip_delete" class="btn btn-primary" value="ì‚­ì œ">
												<button class="btn btn-success" id="btn_excel_download">
								                    <i class="fas fa-download"></i> ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
								                </button>
								                <button class="btn btn-primary" id="btn_excel">
								                    <i class="fas fa-upload"></i> ë°ì´í„° ì—…ë¡œë“œ
								                </button>
											</div>
										</div>
									</div>
									<div id="equipGrid">
										<!-- Toast Grid Ajax -->
									</div>
								</div>
								<!-- /.card-body -->
							</div>
							<!-- /.card -->
						</div>
						<!-- /.col -->
					</div>
					<!-- /.row -->
				</div>
			<!-- /.container-fluid -->
			</section>
			<!-- /.content -->
		</div>
		<!-- /.content-wrapper -->
		<!-- ì¢Œì¸¡ ë©”ë‰´ -->
		<footer th:replace="~{includes/footer :: footer}"></footer>
		<!-- /.ì¢Œì¸¡ ë©”ë‰´ -->
		<!-- Control Sidebar -->
		<aside class="control-sidebar control-sidebar-dark">
			<!-- Control sidebar content goes here -->
		</aside>
		<!-- /.control-sidebar -->
	</div>
	<!-- ./wrapper -->
	
	<!-- Page specific script -->
	<script th:inline="javascript">
		
		tableName = "EQUIPMENT";
		tableCodeId = "EQUIPMENT_ID";
		
		// testìš© ì—‘ì…€ íŒŒì¼ ì´ë¦„ (ìˆ˜ì • í•„ìš”)
		fileName = "ì„¤ë¹„ì •ë³´_ì—‘ì…€_í…ŒìŠ¤íŠ¸.xlsx";
		sheetName = "ì„¤ë¹„ì •ë³´_í…ŒìŠ¤íŠ¸";
		
		let equipGrid = null;
		let equipCurrentSelectedRowKey = null;
		let equipIsEditModeEnabled = false; 
		let allData = [];
		
		// ê·¸ë¦¬ë“œ ì •ë³´ë¥¼ ì €ì¥í•˜ê¸° ìœ„í•œ ì „ì—­ë³€ìˆ˜
		window.gridInstances = window.gridInstances || {};
		
		const equipUrl = '/equipment/equip';
		const equipDataSource = {
			api: {
				readData: {url: equipUrl, method: 'GET'},
				modifyData: {url: equipUrl, method: 'PUT'},
				deleteData: {url: equipUrl, method: 'DELETE', headers: {'X-Delete-IDs': ''}}
			},
			contentType: 'application/json',
		};
		
		const equip_columns =  [
			{header: 'ì„¤ë¹„ì½”ë“œ', name: 'EQUIPMENT_ID', width: 150, sortable: true},
			{header: 'ì„¤ë¹„ëª…', name: 'EQUIPMENT_NAME', width: 200, sortable: true},
			{
				header: 'ì‚¬ìš©ì—¬ë¶€', 
				name: 'EQUIPMENT_STATUS', 
				width: 100,
				sortable: true,
			    align: 'center',
			    formatter: function({value}) {
			        return `<input type="checkbox" ${value === 'Y' ? 'checked' : ''} />`;
			    },
			},
			{header: 'ë¹„ê³ ', name: 'EQUIPMENT_NOTE', width: 300, sortable: true}
		];

		const TextInputRenderer = function(props) {
			const el = document.createElement('input');
			el.type = 'text';
		 	el.style.width = 'calc(100% - 10px)';
		 	el.style.padding = '6px 7px';
		  	el.style.border = 'solid 1px #ddd';
		  	el.style.margin = 'auto 5px';
		  	
		  	this.el = el;
		  	this.render(props);
		}

		TextInputRenderer.prototype.getElement = function () {
			return this.el;
		}
		
		TextInputRenderer.prototype.render = function (props) {
			this.el.value = props.value;
		}
		
		const TextInputBtnRenderer = function(props) {
		    const container = document.createElement('div');
		    container.style.display = 'flex';
		    container.style.alignItems = 'center';
		    container.style.gap = '5px';
		    
		    const el = document.createElement('input');
		    el.type = 'text';
		    el.style.width = 'calc(100% - 10px)';
		    el.style.padding = '6px 7px';
		    el.style.border = 'solid 1px #ddd';
		    el.style.color = 'solid 1px #ddd';
		    el.style.marginLeft = '1px';
		    el.setAttribute('disabled', true); // ì…ë ¥ ë° í´ë¦­ ë¹„í™œì„±í™”
			
			container.appendChild(el);
			
			// EQUIPMENT_ID ê¸°ì¡´ê°’ì€ ìˆ˜ì • ë¶ˆê°€ ì¡°ê±´
			if (!(props.columnInfo.name == 'EQUIPMENT_ID'
				&& equipGrid.getValue(props.rowKey, 'isNew') == null)) {
				const button = document.createElement('button');
			    button.textContent = 'ğŸ”';
			    button.style.border = 'solid 1px #007BFF';
			    button.style.background = 'white';
			    button.style.color = 'white';
			    button.style.padding = '6px 10px';
			    button.style.cursor = 'pointer';
			    button.style.borderRadius = '4px';
			    button.style.marginRight = '5px';
				
				container.appendChild(button);
					
				button.addEventListener('click', function() {
					const row = props.rowKey;
					const column = props.columnInfo.name;
					// props.formattedValueë¡œ ê°€ì ¸ì˜¤ë©´ ëª¨ë‹¬ ë‹¤ì‹œ ë„ìš¸ ë•Œ ê°’ì„ ëª»ë°›ì•„ì˜´.
					const value = equipGrid.getValue(row, column);
					
					$("#inputCodeText").val(value);  // ê·¸ë¦¬ë“œì— ì¶œë ¥ë˜ì–´ìˆëŠ” ê¸°ì¡´ì˜ ê°’
					$("#gridCheckedRow").val(row);  // ì„ íƒí•œ í–‰
					$("#gridCheckedColumn").val(column);  // ì„ íƒí•œ ì—´
					
					copyGrid = equipGrid;  // ì„ íƒí•œ ê°’ ì§‘ì–´ë„£ì„ ê·¸ë¦¬ë“œ ê°ì²´
					
					// ìœ„ì—ì„œ ë³€ê²½í•„ìš”í•œ ê°’ë“¤ ìˆ˜ì •í•œ ë‹¤ìŒ ëª¨ë‹¬ ë„ì›€.
					$('#mesCodeValidate').modal();
			    });
			}
			
		    this.el = container;
		    this.input = el;
		    this.render(props);
		}

		TextInputBtnRenderer.prototype.getElement = function () {
		    return this.el;
		}

		TextInputBtnRenderer.prototype.render = function (props) {
		    this.input.value = props.value;
		}
		
		const CheckboxRenderer = function(props) {
		    const el = document.createElement('input');
		    el.type = 'checkbox';
		    el.checked = (props.value === 'Y');  // ì´ˆê¸°ê°’ ì§€ì •
		
			el.addEventListener('change', function() {
		        props.grid.setValue(props.rowKey, props.columnInfo.name, el.checked ? 'Y' : 'N'); // ì¦‰ì‹œ ê°’ ì—…ë°ì´íŠ¸
		    });
		    		
		    this.el = el;
		};

		CheckboxRenderer.prototype.getElement = function() {
		    return this.el;
		};

		CheckboxRenderer.prototype.getValue = function() {
		    return this.el.checked ? 'Y' : 'N';
		};

		CheckboxRenderer.prototype.mounted = function() {
		    this.el.focus();
		};
		
		$(function () {
			grid();
			
			// ë°ì´í„° ì—…ë¡œë“œ (ì—‘ì…€) ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
			$('#btn_excel').on('click', function () {
				$('#excelModal').modal();
			});
		});

		function grid() {
			equipGrid = new tui.Grid({
				el: document.getElementById('equipGrid'),
				data: equipDataSource,
				scrollX: true,
				scrollY: true,
				bodyHeight: 500,
				rowHeaders: ['checkbox'],
				editingEvent: 'click',
				columns: equip_columns
			});
			
			window.gridInstances['equipGrid'] = {
					instance: equipGrid,
				    element: document.getElementById('equipGrid')  // DOM ì—˜ë¦¬ë¨¼íŠ¸ ì €ì¥
			};
			
			setTimeout(function () {
			    allData = equipGrid.getData();
			    console.log("ì „ì²´ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:", allData);
			}, 1);
			
			// ì„œë²„ì—ì„œ ë°ì´í„°ë¥¼ ë°›ì•„ì˜¨ í›„ allDataì— ì €ì¥
			equipGrid.on('response', function () {
				allData = equipGrid.getData();
				console.log("allData : " + allData);
			});

			equipGrid.on('failResponse', function (ev) {
				alert(JSON.parse(ev.xhr.responseText).message);
				alert("Response ì‹¤íŒ¨");
			});
			
			console.log("equipDataSource:", equipDataSource);
			


			equipGrid.on('editingStart', function (ev) {
				const {rowKey, columnName, value} = ev;
				const rowData = equipGrid.getRow(rowKey);
			});
			
			equipGrid.on('click', (ev) => {
			    if (ev.targetType != "cell" || equipIsEditModeEnabled) {
					return;
				}

			    const newRowKey = ev.rowKey;

			    if (equipCurrentSelectedRowKey != null) {
			    	equipGrid.removeRowClassName(equipCurrentSelectedRowKey, 'selected-row');
			    }

			    if (equipCurrentSelectedRowKey != newRowKey) {
			    	equipGrid.addRowClassName(newRowKey, 'selected-row');
			    	equipCurrentSelectedRowKey = newRowKey;
			    } else {
			        // ê°™ì€ í–‰ì„ í´ë¦­í•œ ê²½ìš° ì„ íƒ í•´ì œ
			        equipCurrentSelectedRowKey = null;
			    }
			});
		}
		
		$("#btn_equip_add_row").on("click", function () {
			const newRowKey = equipGrid.appendRow(
				{
					"EQUIPMENT_ID": '',
					"EQUIPMENT_NAME": '',
					"EQUIPMENT_STATUS": '',
					"EQUIPMENT_NOTE": '',
					isNew: true
				},
				{focus: true}
			);
		});
		
		$("#btn_equip_remove_row").on("click", function () {
		    const rowCount = equipGrid.getRowCount(); // í˜„ì¬ í–‰ ê°œìˆ˜ ê°€ì ¸ì˜¤ê¸°
		    
		    const allRows = equipGrid.getData(); // ì „ì²´ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
		    const newRows = allRows.filter(row => row.isNew); // ìƒˆë¡œ ì¶”ê°€ëœ í–‰ë§Œ í•„í„°ë§
		    
		    if (newRows.length === 0) {
		        alert("ì‚­ì œí•  ìˆ˜ ìˆëŠ” ì‹ ê·œ í–‰ì´ ì—†ìŠµë‹ˆë‹¤.");
		        return;
		    }

		    const lastRowKey = equipGrid.getRowAt(rowCount - 1).rowKey; // ë§ˆì§€ë§‰ í–‰ì˜ rowKey ê°€ì ¸ì˜¤ê¸°
		    equipGrid.removeRow(lastRowKey); // ë§ˆì§€ë§‰ í–‰ ì‚­ì œ
		});
		
		// ìˆ˜ì • ëª¨ë“œ í† ê¸€ ë²„íŠ¼ ì´ë²¤íŠ¸
		$("#btn_equip_toggleEditMode").on("click", function () {
			equipIsEditModeEnabled = !equipIsEditModeEnabled; // ìˆ˜ì • ëª¨ë“œ ìƒíƒœ í† ê¸€
		    
		    if (equipIsEditModeEnabled) {
				$("#btn_equip_add_row").show();
				$("#btn_equip_remove_row").show();
		    } else {
		    	$("#btn_equip_add_row").hide();
				$("#btn_equip_remove_row").hide();
		    }
		    
		    if (equipIsEditModeEnabled) {
		    	equipGrid.setColumns([
					{header: 'ì„¤ë¹„ì½”ë“œ *', name: 'EQUIPMENT_ID', width: 150, renderer: { type: TextInputBtnRenderer }},
					{header: 'ì„¤ë¹„ëª… *', name: 'EQUIPMENT_NAME', width: 200, editor: 'text', renderer: { type: TextInputRenderer }},
					{
						header: 'ì‚¬ìš©ì—¬ë¶€ *', 
						name: 'EQUIPMENT_STATUS', 
						width: 100, 
					    align: 'center',
					    formatter: function({value}) {
					        return `<input type="checkbox" ${value === 'Y' ? 'checked' : ''} />`;
					    },
						renderer: { type: CheckboxRenderer }
					}, 
					{header: 'ë¹„ê³  *', name: 'EQUIPMENT_NOTE', width: 300, editor: 'text', renderer: { type: TextInputRenderer }}
		        ]);
		    } else {
		    	equipGrid.finishEditing();  // í˜„ì¬ í¸ì§‘ ì¤‘ì¸ ì…€ ì¢…ë£Œë¥¼ ì•ˆí•˜ë©´ ìˆ˜ì •ëª¨ë“œ ì¢…ë£Œì‹œ ê°’ì´ ì´ˆê¸°í™” ë˜ë²„ë¦¼
		    	equipGrid.setColumns(equip_columns);
		    }
		});
		
		$("#btn_equip_modify").on("click", function() {
			equipGrid.finishEditing();  // í˜„ì¬ í¸ì§‘ ì¤‘ì¸ ì…€ ì¢…ë£Œë¥¼ ì•ˆí•˜ë©´ ê°’ì´ ì´ˆê¸°í™” ë˜ë²„ë¦¼
			
		    let createdRows = equipGrid.getModifiedRows().createdRows;
		    let updatedRows = equipGrid.getModifiedRows().updatedRows;
		    
		    // í•„ìˆ˜ ì…ë ¥ ì»¬ëŸ¼
		    const requiredFields = ["EQUIPMENT_ID", "EQUIPMENT_NAME", "EQUIPMENT_STATUS"];

		    let validCreatedRows = createdRows.filter(row =>
		        requiredFields.every(field => 
		        	row[field] && row[field].trim() !== ''
		        )
		    );
		    
		    let validUpdatedRows = updatedRows.filter(row =>
		        requiredFields.every(field => 
		        	row[field] && row[field].trim() !== ''
		        )
		    );
		    
		    if (createdRows.length == 0 && updatedRows.length == 0) {
		    	alert("ìˆ˜ì •ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
		        return;
		    }

			if (createdRows.length > 0) {
				if ((validCreatedRows.length == 0)
					|| (validCreatedRows.length != createdRows.length)) {
					alert("í•„ìˆ˜ê°’ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
			        return;
				}
			}
				
			if (updatedRows.length > 0 && validUpdatedRows.length == 0) {
				alert("í•„ìˆ˜ê°’ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
		        return;
			}
			
			equipGrid.request('modifyData');
			equipGrid.setColumns(equip_columns);
			
			equipIsEditModeEnabled = false;
	    	$("#btn_equip_add_row").hide();
			$("#btn_equip_remove_row").hide();
		});
		
		$("#btn_equip_delete").on("click", function() {
			equipGrid.removeCheckedRows();
			
			// ë°˜ë“œì‹œ removeCheckedRows()í›„ì— ì‹¤í–‰ ìˆœì„œ
			// DELETEëŠ” bodyê°€ ì—†ê³  urlê³¼ headerë§Œ ìˆìŒ, ê¸°ë³¸ê°’ url -> urlëŒ€ì‹  headerì— ë‹´ì•„ ë³´ëƒ„
			const ids = equipGrid.getModifiedRows().deletedRows
				.map(row => encodeURIComponent(row.EQUIPMENT_ID))  // í•œê¸€ ë³€í™˜
				.join(',');
			equipDataSource.api.deleteData.headers['X-Delete-IDs'] = ids;
			
		    equipGrid.request('deleteData');
			equipGrid.reloadData();  // ì‹¤íŒ¨ì‹œ í…Œì´ë¸” ë¦¬ë¡œë“œ
		});
		
		$("#btn_equip_search").on("click", function() {
			
		    const equipId = $("#equipId").val().trim().toLowerCase();
		    const equipName = $("#equipName").val().trim().toLowerCase();
		    const equipStatus = $("select[name='equipStatus']").val(); // ì‚¬ìš©ì—¬ë¶€ (ì„ íƒê°’)

		    // í•„í„°ë§ëœ ë°ì´í„° ì¶”ì¶œ
		    const filteredData = allData.filter(item => {
		        return (equipId === "" || item.EQUIPMENT_ID.toLowerCase().includes(equipId)) &&
		               (equipName === "" || item.EQUIPMENT_NAME.toLowerCase().includes(equipName)) &&
		               (equipStatus === "" || item.EQUIPMENT_STATUS === equipStatus);
		    });
			
			console.log(filteredData);

		    // í•„í„°ë§ëœ ë°ì´í„°ë¡œ ê·¸ë¦¬ë“œ ê°±ì‹ 
		    equipGrid.resetData(filteredData);
		});
	</script>
</body>

</html>