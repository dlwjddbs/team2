<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>êµ¬ë§¤ë°œì£¼ë“±ë¡</title>
	
<!-- 	í† ìŠ¤íŠ¸ í˜ì´ì§• -->
	<link rel="stylesheet" href="https://uicdn.toast.com/tui.pagination/latest/tui-pagination.css">
	<!-- Bootstrap & CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
	<!-- Google Font: Source Sans Pro -->
	<link rel="stylesheet"
		href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
	<!-- Font Awesome -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" />
	<!-- DataTables -->
	<link rel="stylesheet" href="../../plugins/datatables-bs4/css/dataTables.bootstrap4.min.css">
	<link rel="stylesheet" href="../../plugins/datatables-responsive/css/responsive.bootstrap4.min.css">
	<link rel="stylesheet" href="../../plugins/datatables-buttons/css/buttons.bootstrap4.min.css">
	<!-- Theme style -->
	<link rel="stylesheet" href="../../dist/css/adminlte.min.css">
	<!-- daterange picker -->
	<link rel="stylesheet" href="../../plugins/daterangepicker/daterangepicker.css">
	<!-- Toast Grid -->
	<link rel="stylesheet" href="https://uicdn.toast.com/grid/latest/tui-grid.css" />
	<!-- jQuery OrgChart CSS CDN -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/orgchart/5.0.0/css/jquery.orgchart.min.css"
		integrity="sha512-9A2BSSUL5eXVMWwrB8aDX8GeOOSMMVCk3fvqOplnswmo4IN4s6DW2ywpb3VCDcGCVwDc3g6S1k9T72NsCkgw5A=="
		crossorigin="anonymous" referrerpolicy="no-referrer" />
	<meta name="_csrf" th:content="${_csrf.token}" />
	<meta name="_csrf_header" th:content="${_csrf.headerName}" />
	
				<!-- jQuery -->
			<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
			<!-- Bootstrap 4 -->
			<script src="../../plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
			<!-- AdminLTE App -->
			<script src="../../dist/js/adminlte.min.js"></script>
			<script src="https://cdn.jsdelivr.net/npm/notiflix@3.2.6/dist/notiflix-aio-3.2.6.min.js"></script>
<!-- 			í† ìŠ¤íŠ¸ í˜ì´ì§• -->
			<script src="https://uicdn.toast.com/tui.pagination/latest/tui-pagination.min.js"></script>
			
			<script src="https://uicdn.toast.com/tui-grid/latest/tui-grid.min.js"></script>
			

	<style>
		.table-container {
			margin-top: 20px;
		}

		.divider {
			border-top: 4px solid #000;
			margin: 30px 0;
		}

		.btn-actions {
			display: flex;
			gap: 10px;
		}

		.hidden {
			display: none;
		}
	</style>
</head>

<body class="hold-transition sidebar-mini">
	<div class="wrapper">
		<!-- ìƒë‹¨ ë©”ë‰´ -->
		<nav th:replace="~{includes/navbar :: navbar}"></nav>
		<!-- /.ìƒë‹¨ ë©”ë‰´ -->
		<!-- ì¢Œì¸¡ ë©”ë‰´ -->
		<aside th:replace="~{includes/sidebar :: sidebar}"></aside>
		<!-- /.ì¢Œì¸¡ ë©”ë‰´ -->
		<!-- Content Wrapper. Contains page content -->
		<div class="content-wrapper">
			<!-- ì½˜í…ì¸  í—¤ë” (Page header) -->
			<nav th:replace="~{includes/modals/purchaseMtl :: materialModal}"></nav>
			<nav th:replace="~{includes/modals/purchaseClt :: purchaseClt}"></nav>
			
			
			 			<nav th:replace="~{includes/pageHeader :: pageHeader}"></nav> 

			<section class="content">
				<div class="container-fluid">
					<!-- ì²« ë²ˆì§¸ row (êµ¬ë§¤ë°œì£¼) -->
					<div class="row">
						<div class="col-12">
							<div class="card">
								<div class="card-header">
									<h5>êµ¬ë§¤ë°œì£¼</h5>
									<div class="card-tools">
										<input type="button" id="btn_add_row" class="btn btn-primary" value="ì‹ ê·œ"> <input
											type="button" id="save" class="btn btn-primary" value="ì €ì¥"> <input
											type="button" id="btn_delete" class="btn btn-primary"
											onclick="deleteRows(this.id)" value="ì‚­ì œ">
									</div>
								</div>
								<div class="card-body">
									<div id="toast_single"></div>
								</div>
							</div>
						</div>
					</div>

					<!-- êµ¬ë¶„ì„  -->
					<div class="divider hidden" id="divider"></div>

					<!-- ë‘ ë²ˆì§¸ row (êµ¬ë§¤ë°œì£¼ ìƒì„¸) -->
					<div class="row hidden" id="detail_section">
						<div class="col-12">
							<div class="card">
								<div class="card-header">
									<h5>êµ¬ë§¤ë°œì£¼ ìƒì„¸</h5>
									<div class="card-tools">
										<input type="button" id="btn_add_row2" class="btn btn-primary" value="ì‹ ê·œ">
										<input type="button" id="saveDetail" class="btn btn-primary" value="ì €ì¥"> <input
											type="button" id="btn_delete2" class="btn btn-primary"
											onclick="deleteRows(this.id)" value="ì‚­ì œ">
									</div>
								</div>
								<div class="card-body">
									<div id="toast_single2"></div>
									<!-- êµ¬ë§¤ë°œì£¼ ìƒì„¸ ì˜ì—­ -->
								</div>
							</div>
						</div>
					</div>
				</div>
				
<!-- í’ˆëª© ì¡°íšŒ ëª¨ë‹¬ -->
<div class="modal fade" id="materialModal" tabindex="-1" aria-labelledby="materialModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content" style="width: 150%; margin: auto;">
            <div class="modal-header">
                <h5 class="modal-title" id="materialModalLabel">í’ˆëª© ì¡°íšŒ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>í’ˆëª©ì½”ë“œ</th>
                            <th>í’ˆëª©ëª…</th>
                            <th>ë‹¨ê°€</th>
                            <th>ì„ íƒ</th>
                        </tr>
                    </thead>
                    <tbody id="modalMaterialList">
<!--                         ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ë°ì´í„°ë¥¼ ì¶”ê°€ -->
                    </tbody>
                </table>
				
<!-- 				í˜ì´ì§• ë²„íŠ¼ì„ í‘œì‹œí•  ì˜ì—­ -->
				        <div id="paginationContainer" class="mt-3 d-flex justify-content-center">
<!-- 				          ì—¬ê¸°ì— ì´ì „, í˜ì´ì§€ë²ˆí˜¸, ë‹¤ìŒ ë²„íŠ¼ ìƒì„± -->		  
            </div>
        </div>
    </div>
</div>
				



			</section>


			<style>
				.selected-row {
					background-color: #d1ffd6;
				}

				.deselected-row {
					background-color: #ffd1d1;
				}
			</style>
			<!-- Page specific script -->
			<script>
				const token = $("meta[name='_csrf']").attr("content")
				const header = $("meta[name='_csrf_header']").attr("content");
				const name = $("#userName").val();

				$(function () {
					initGrids();
				});

				// Toast Grid ì„¤ì •
				let cltId = "";
				let grid1;
				let grid2;

				const url = 'getPurchase';
				const dataSource = {
					api: {
						createData: {url: url, method: 'POST', headers: {[header]: token}},
						readData: {url: url, method: 'POST', headers: {[header]: token}},
						updateData: {url: url, method: 'PUT', headers: {[header]: token}},
						deleteData: {url: url, method: 'DELETE', headers: {'X-Delete-IDs': ''}}
					},
					contentType: 'application/json',
				};
				const columns = [
					{header: 'P/Oë²ˆí˜¸', name: 'PO_ID', align: 'center' },
					{header: 'P/Oì¼ì', name: 'CREATE_DATE', align: 'center', editor: 'text'},
					{header: 'ì£¼ë¬¸ë²ˆí˜¸', name: 'PO_NUM', align: 'center'},
					{header: 'ë‹´ë‹¹ì', name: 'MEMBER_NAME', align: 'center'},
					{header: 'ê±°ë˜ì²˜ì½”ë“œ', name: 'CLIENT_ID', hidden: true},
					{header: 'ê±°ë˜ì²˜', name: 'CLIENT_NAME', align: 'center', 	formatter: function({ value, row }) {
						return `
						<div style="display: flex; justify-content: flex-end; align-items: center;">
						<span class="client-id-display" style="text-align: center; width: 100%; display: inline-block;">
				          ${value ? value : ''}
				        </span>
						          <button class="client-modal-btn" data-row-key="${row.rowKey}" 
						              style="border: none; background: none; color: #007bff; cursor: pointer; font-size: 15px;">
						              ğŸ”
						          </button>
						      </div> `;
					            }},
					{header: 'í’ˆëª©(ìˆ˜)', name: 'PO_COUNT', align: 'center'},
					{header: 'ê¸ˆì•¡', name: 'PO_PRICE', align: 'center'},
					{header: 'ìˆ˜ì •ì¼', name: 'UPDATE_DATE', align: 'center'},
					{header: 'ìˆ˜ì •ì', name: 'UPDATE_MEMBER', align: 'center'},
					{header: 'ìƒíƒœ', name: 'PO_STATUS', align: 'center',
						formatter: ({value}) => {
							const color = {"ë¯¸ê²°": "red", "ë§ˆê°": "blue"}[value] || "black";
							return `<span style="color: ${color}; font-weight: bold;">${value}</span>`;
						}
					}
				];
				
				let poId = "";
				
				// grid2 ì»¬ëŸ¼ ì„¤ì • (êµ¬ë§¤ ë°œì£¼ ìƒì„¸)
				const columns2 = [
				{header: 'ìƒì„¸ë²ˆí˜¸', name: 'PODETAIL_ID', align: 'center'},
					{header: 'í’ˆëª©ì½”ë“œ', name: 'MATERIAL_ID', align: 'center', formatter: function({ value, row }) {
						return `
						<div style="display: flex; justify-content: flex-end; align-items: center;">
						<span class="material-id-display" style="text-align: center; width: 100%; display: inline-block;">
				          ${value ? value : ''}
				        </span>
				        <button class="material-modal-btn" data-row-key="${row.rowKey}" 
						              style="border: none; background: none; color: #007bff; cursor: pointer; font-size: 15px;">
						              ğŸ”
						          </button>
						      </div> `;
					            }},
					{header: 'í’ˆëª©ëª…', name: 'MATERIAL_NAME', align: 'center', formatter: function({ value, row }) {
						console.log("MATERIAL_NM value:", value, "row:", row);
						return `
						<div style="display: flex; justify-content: flex-end; align-items: center;">
						<span class="material-nm-display" style="text-align: center; width: 100%; display: inline-block;">
				          ${value ? value : ''}
				        </span>	
				        <button class="material-modal-btn" data-row-key="${row.rowKey}" 
						              style="border: none; background: none; color: #007bff; cursor: pointer; font-size: 15px;">
						              ğŸ”
						          </button>
						      </div> `;
					            }},
					{header: 'ìˆ˜ëŸ‰', name: 'PO_COUNT', align: 'center', editor: 'text'},
					{header: 'ë‹¨ê°€', name: 'MATERIAL_PRICE', align: 'center', editor: 'text'},
					{header: 'ì´ê¸ˆì•¡', name: 'TOTAL_PRICE', align: 'center'},
					{header: 'ìˆ˜ì •ì¼', name: 'UPDATE_DATE', align: 'center'},
					{header: 'ìˆ˜ì •ì', name: 'UPDATE_MEMBER', align: 'center'},
					//{header: 'ë‚©ê¸°ì¼', name: 'DELIVERY_DATE', align: 'center', editor: 'text'},
					//{header: 'ìƒíƒœ', name: 'PO_STATUS', align: 'center'},
				];


				let rowIdx;
				function initGrids() {
					grid1 = new tui.Grid({
						el: document.getElementById('toast_single'),
						data: dataSource,
						scrollX: true,
						scrollY: true,
						rowHeaders: ['checkbox'],
						editingEvent: 'click',
						pageOptions: {
				            useClient: true,  // ì„œë²„ì—ì„œ í˜ì´ì§• ì²˜ë¦¬
				            perPage: 10        // í˜ì´ì§€ë‹¹ 10ê°œ
				        },
						columns: columns,
					});


					fetch('/getPurchase', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
							[header]: token
						},
						body: JSON.stringify({})
					})
						.then(response => response.json())
						.then(data => {
							console.log("ì„œë²„ ì‘ë‹µ ë°ì´í„°:", data);
							grid1.resetData(data);
 							
						})
						.catch(error => console.error("ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error));

					// êµ¬ë§¤ë°œì£¼ ìƒì„¸ ë¦¬ìŠ¤íŠ¸ë¥¼ ìˆ¨ê¹€ ìƒíƒœì—ì„œ ì‹œì‘
					$("#detail_section").hide();
					$("#divider").hide();

					// í–‰ í´ë¦­ ì‹œ ìƒì„¸ ë¦¬ìŠ¤íŠ¸ ë³´ì´ê¸°
					grid1.on('click', function (ev) {
						if (ev.rowKey === null)
							return;
						const selectedRow = grid1.getRow(ev.rowKey);
						console.log("ì„ íƒí•œ í–‰ ë°ì´í„°:", selectedRow); // ì´ ì¤„ ì¶”ê°€
						console.log("ì„ íƒí•œ í–‰ì˜ PO_ID:", selectedRow.PO_ID);
						poId = selectedRow.PO_ID;
						if (!selectedRow) return;
						rowIdx = ev.rowKey;
						
						console.info(cltId);

						$("#detail_section").fadeIn(300).removeClass("hidden").addClass("visible");
						$("#divider").fadeIn(300).removeClass("hidden").addClass("visible");

						// ì„ íƒí•œ ë°œì£¼ë²ˆí˜¸(PO_ID)ë¡œ ìƒì„¸ ë°ì´í„° ìš”ì²­
						if(selectedRow.PO_ID != null){
							fetch('/getPurchaseDetail', {
								method: 'POST',
								headers: {
									'Content-Type': 'application/json',
									[header]: token
								},
								body: JSON.stringify({PO_ID: selectedRow.PO_ID})
							})
								.then(response => response.json())
								.then(data => {
									dtlGrid(data);
								})
								.catch(error => console.error("grid2 ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error));
						}
					});

					// ë”ë¸” í´ë¦­í•˜ë©´ ìƒì„¸ ë¦¬ìŠ¤íŠ¸ ìˆ¨ê¸°ê¸°
					grid1.on('dblclick', function () {
						$("#detail_section").fadeOut(300).removeClass("visible").addClass("hidden");
						$("#divider").fadeOut(300).removeClass("visible").addClass("hidden");
						grid2.resetData([]);
					});

					// -----------------
					function dtlGrid(data) {
						if (!grid2) {
							grid2 = new tui.Grid({
							el: document.getElementById('toast_single2'),
							data: [],
							scrollX: true,
							scrollY: true,
							rowHeaders: ['checkbox'],
							editingEvent: 'click',
							pageOptions: {
					        useClient: true,  // ì„œë²„ì—ì„œ í˜ì´ì§• ì²˜ë¦¬
					        perPage: 10        // í˜ì´ì§€ë‹¹ 10ê°œ
					        },
							columns: columns2,
						});
						} 

						grid2.resetData(data);
						
	
						// grid2 ê°’ ë³€ê²½ ì‹œ ìë™ ê³„ì‚° (ì´ê¸ˆì•¡ ì—…ë°ì´íŠ¸)
					    grid2.on('afterChange', (event) => {
					        event.changes.forEach(({ rowKey, columnName, value }) => {
					            const newValue = Number(value) || 0;
					            const previousValue = previousCellValues[rowKey]?.[columnName] ?? 0;

					            // ì´ì „ ê°’ê³¼ ìƒˆë¡œìš´ ê°’ì´ ë‹¤ë¥¼ ë•Œë§Œ ì´í•© ì—…ë°ì´íŠ¸
					            if (newValue !== previousValue) {
					                if (columnName === "PO_COUNT" || columnName === "MATERIAL_PRICE") {
					                    const count = Number(grid2.getValue(rowKey, "PO_COUNT")) || 0;
					                    const price = Number(grid2.getValue(rowKey, "MATERIAL_PRICE")) || 0;
					                    const totalPrice = count * price; // ì´ê¸ˆì•¡ ê³„ì‚°

					                    grid2.setValue(rowKey, "TOTAL_PRICE", totalPrice);
					                }
					            }
					        });
					    });
						
						
						// ì²´í¬ë°•ìŠ¤ê°€ í™œì„±í™”ëœ í–‰ì˜ indexë¥¼ ë°°ì—´ì— ì €ì¥
						grid2.on('check', (ev) => {
							delRows.push(ev.rowKey);
						});
						
						let totalItemCount = 0;
					    let totalItemPrice = 0;
					    const previousCellValues = {}; // ë³€ê²½ ì „ ì…€ ê°’ì„ ì €ì¥í•˜ëŠ” ê°ì²´

					    // ë³€ê²½ ì „ ê°’ ì €ì¥ (beforeChange ì´ë²¤íŠ¸)
					    grid2.on('beforeChange', (event) => {
					        event.changes.forEach(({ rowKey, columnName }) => {
					            if (!previousCellValues[rowKey]) {
					                previousCellValues[rowKey] = {};
					            }
					            // ë³€ê²½ ì „ ê°’ì„ grid2ì—ì„œ ê°€ì ¸ì™€ ì €ì¥ (DBì—ì„œ ë¶ˆëŸ¬ì˜¨ ê¸°ì¡´ ê°’ í¬í•¨)
					            const previousValue = Number(grid2.getValue(rowKey, columnName)) || 0;
					            previousCellValues[rowKey][columnName] = previousValue;
					        });
					    });
						
					    
					    // ê°’ ë³€ê²½ ì‹œ ì´í•© ì—…ë°ì´íŠ¸ (ì´ì „ ê°’ ë°˜ì˜)
					    grid2.on('afterChange', (event) => {
					        event.changes.forEach(({ rowKey, columnName, value }) => {
					            const newValue = Number(value) || 0;
					            // ì´ì „ ê°’ì´ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê²½ìš° 0ìœ¼ë¡œ ì²˜ë¦¬
					            const previousValue = previousCellValues[rowKey]?.[columnName] ?? 0;

					            // ì´ì „ ê°’ê³¼ ìƒˆë¡œìš´ ê°’ì´ ë‹¤ë¥¼ ë•Œë§Œ ì´í•© ì—…ë°ì´íŠ¸ (ì¤‘ë³µ ë°©ì§€)
					            if (newValue !== previousValue) {
					                if (columnName === "PO_COUNT") {
					                    totalItemCount = totalItemCount - previousValue + newValue;
					                    grid1.setValue(rowIdx, "PO_COUNT", totalItemCount);
					                } else if (columnName === "PO_PRICE") {
					                    totalItemPrice = totalItemPrice - previousValue + newValue;
					                    grid1.setValue(rowIdx, "PO_PRICE", totalItemPrice);
					                }
					            }
					        });
					    });
					}

				}

				$("#btn_add_row").on("click", function () {
					let today = new Date();
					let year = today.getFullYear(); // ë…„ë„
					let month = String(today.getMonth() + 1).padStart(2, "0");  // ì›”
					let date = String(today.getDate()).padStart(2, "0");  // ë‚ ì§œ
					const newRowKey = grid1.appendRow(
						{
							"CREATE_DATE": year + '-' + month + '-' + date,
							"PO_STATUS": 'ë¯¸ê²°',
						},
						{focus: true}
					);
				});

				$("#btn_add_row2").on("click", function () {
					let today = new Date();
					let year = today.getFullYear(); // ë…„ë„
					let month = String(today.getMonth() + 1).padStart(2, "0");  // ì›”
					let date = String(today.getDate()).padStart(2, "0");  // ë‚ ì§œ
					const newRowKey = grid2.appendRow(
						{
							"PO_DATE": year + '-' + month + '-' + date,

						},
						{focus: true}
					);
				});

				// ì €ì¥ ë²„íŠ¼ ì´ë²¤íŠ¸
				save.addEventListener('mousedown', handleSave);
				saveDetail.addEventListener('mousedown', detailSave);
				
				
				//ì‚­ì œ
				let delRows = [];

				function deleteRows(btnId) {

					let gridNm = "";

					if (btnId == "btn_delete") {
						gridNm = grid1;
					} else {
						gridNm = grid2;
					}

					const checkedRows = gridNm.getCheckedRows(); // ì²´í¬ëœ í–‰ ê°€ì ¸ì˜¤ê¸°

					if (checkedRows.length === 0) {
						alert("ì‚­ì œí•  í–‰ì„ ì„ íƒí•˜ì„¸ìš”.");
						return;
					}

					checkedRows.forEach(row => {
						delRows.push({...row, rowType: "delete"}); // ì‚­ì œí•  ë°ì´í„°ë¥¼ delRows ë°°ì—´ì— ì €ì¥
						gridNm.removeRow(row.rowKey); // í™”ë©´ì—ì„œ í–‰ ì‚­ì œ
					});

					console.info("ì‚­ì œí•  ë°ì´í„° ëª©ë¡:", delRows);
				}



				// ì €ì¥ í•¨ìˆ˜
				function handleSave() {
					grid1.blur(); // í¬ì»¤ìŠ¤ í•´ì œ

					const modifiedRows = grid1.getModifiedRows();
					const createdRows = modifiedRows.createdRows.map(row => ({...row, rowType: "insert", cltId:cltId}));
					const updatedRows = modifiedRows.updatedRows.map(row => ({...row, rowType: "update", cltId:cltId}));
					const deletedRows = modifiedRows.deletedRows.map(row => ({...row, rowType: "delete", cltId:cltId}));

					const allData = [...createdRows, ...updatedRows, ...deletedRows];

					if (allData.length === 0) {
						alert("ë³€ê²½ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
						return;
					}

					console.log("ì„œë²„ë¡œ ì „ì†¡í•  ë°ì´í„°:", allData);

					$.ajax({
						url: "/savePurchase",
						type: 'POST',
						contentType: "application/json",
						data: JSON.stringify(allData),
						beforeSend: (xhr) => xhr.setRequestHeader(header, token),
						success: (res) => {
							console.log("ì„œë²„ ì‘ë‹µ:", res); // ì‘ë‹µ ê°’ í™•ì¸
							if (res.status == "success") {
								showSuccess("ì €ì¥ ì„±ê³µ!", true);
								delRows = []; // ì‚­ì œ ëª©ë¡ ì´ˆê¸°í™” (ì„±ê³µ ì‹œ)
							} else {
								showError("ì €ì¥ ì‹¤íŒ¨");
							}
						},
						error: () => showError("ì„œë²„ ì˜¤ë¥˜ ë°œìƒ"),
					});
				}

				// ì €ì¥ í•¨ìˆ˜
				function detailSave() {
					grid2.blur(); // í¬ì»¤ìŠ¤ í•´ì œ
					console.info(poId);

					const modifiedRows2 = grid2.getModifiedRows();
					const createdRows2 = modifiedRows2.createdRows.map(row => ({...row, rowType: "insert", poId:poId}));
					const updatedRows2 = modifiedRows2.updatedRows.map(row => ({...row, rowType: "update", poId:poId}));
					const deletedRows2 = modifiedRows2.deletedRows.map(row => ({...row, rowType: "delete", poId:poId}));

					const allData = [...createdRows2, ...updatedRows2, ...deletedRows2];
					
					if (allData.length === 0) {
						alert("ë³€ê²½ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
						return;
					}

					console.log("ì„œë²„ë¡œ ì „ì†¡í•  ë°ì´í„°:", allData);

					$.ajax({
						url: "/saveDetail",
						type: 'POST',
						contentType: "application/json",
						data: JSON.stringify(allData),
						beforeSend: (xhr) => xhr.setRequestHeader(header, token),
						success: (res) => {
							console.log("ìƒì„¸ ì„œë²„ ì‘ë‹µ:", res); // ì‘ë‹µ ê°’ í™•ì¸
							if (res.status == "success") {
								showSuccess("ìƒì„¸ ì €ì¥ ì„±ê³µ!", true);
								delRows = []; // ì‚­ì œ ëª©ë¡ ì´ˆê¸°í™” (ì„±ê³µ ì‹œ)
							} else {
								showError("ìƒì„¸ ì €ì¥ ì‹¤íŒ¨");
							}
						},
						error: () => showError("ì„œë²„ ì˜¤ë¥˜ ë°œìƒ"),
					});
				}
				
				

				// ë©”ì‹œì§€
				function showSuccess(message, reload = false) {
					Notiflix.Notify.success('ì €ì¥ ì„±ê³µ!');
				}

				function showError(message) {
					Notiflix.Notify.failure('ì €ì¥ ì‹¤íŒ¨!');
				}

// 				í’ˆëª© ëª¨ë‹¬ ì—´ê¸°
				let selectedRowKey = null;

			    $(document).on("click", ".material-modal-btn", function () {
			        selectedRowKey = $(this).data("row-key"); // ì„ íƒí•œ grid2ì˜ í–‰ key ì €ì¥
			        loadMaterialList(); // í’ˆëª© ë¦¬ìŠ¤íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸°
			        $("#materialModal").modal("show");
			    });

				$(document).on("click", ".select-material", function () {
							        const MATERIAL_ID = $(this).data("material-id");
							        const MATERIAL_NAME = $(this).data("material-name");
							        const MATERIAL_PRICE = $(this).data("material-price");
							        
							        if (selectedRowKey !== null) {
							            grid2.setValue(selectedRowKey, "MATERIAL_ID", MATERIAL_ID);
							            grid2.setValue(selectedRowKey, "MATERIAL_NAME", MATERIAL_NAME);
							            grid2.setValue(selectedRowKey, "MATERIAL_PRICE", MATERIAL_PRICE);
							            console.log(`grid2 ì—…ë°ì´íŠ¸ ì™„ë£Œ: ${MATERIAL_ID}, ${MATERIAL_NAME}, ${MATERIAL_PRICE}`);
							        }else {
							            console.error("grid2ì—ì„œ ì˜¬ë°”ë¥¸ í–‰ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ!");
							        }
							        
							        $("#materialModal").modal("hide");
							    });
								
				
																
	
					$(document).on("click", ".client-modal-btn", function (props) {
						// selectedRowKey = $(this).data("row-key"); // ì„ íƒí•œ grid2ì˜ í–‰ key ì €ì¥
						 const rowKey = $(this).data("row-key");
				    // ì—…ë°ì´íŠ¸í•  ì»¬ëŸ¼ ì´ë¦„ ì§€ì • (ì˜ˆ: "CLIENT_ID")
				    $("#clientRow").val(rowKey);
						
						$("#purchaseClt").modal("show");
							       // loadClientList(); // ê±°ë˜ì²˜ ë¦¬ìŠ¤íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸°
							    });							
									
			</script>

				
				
				
</body>

</html>